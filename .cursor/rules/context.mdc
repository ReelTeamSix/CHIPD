---
description: global app context
globs: 
alwaysApply: false
---
## Project description

## Expected workflow
- review feature requirements
- plan implementation
- update schema if needed 
- implement core functionality

Please think out loud and provide 
- Overview of completed work
- Rationale for decision
- next steps checklist

You must ensure 
- when implementing new feature it doesn't break existing feature

## Git Workflow (ALWAYS FOLLOW)

### Before ANY Work
```bash
git pull origin master  # Always sync first
```

### Branch Strategy
- `master` - Protected, stable releases only
- `develop` - Integration branch for features
- `feature/<name>` - Individual features (e.g., `feature/nfc-handshake`)
- `fix/<name>` - Bug fixes

### Checkpoint Tags (MVP Phases)
| Tag | Description | Status |
|-----|-------------|--------|
| `v0.1.0-theme-refactor` | CHIP'D theme system | âœ… Complete |
| `v0.1.1-auth-cleanup` | Auth flow, Supabase setup | âœ… Complete |
| `v0.1.2-schema-v1.1` | Database schema v1.1.0 deployed | âœ… Complete |
| `v0.2.0-phase1-nfc` | Phase 1: NFC + Lab Mode + Rounds | ðŸ”² In Progress |
| `v0.3.0-phase2-caddie` | Phase 2: GPS + Distance + Maps | ðŸ”² Pending |
| `v0.4.0-phase3-games` | Phase 3: Side Games + Chips | ðŸ”² Pending |
| `v1.0.0-mvp` | MVP Release | ðŸ”² Pending |

### Commit Convention
```
<type>: <description>

Types: feat, fix, refactor, docs, test, chore
```

### Creating a Checkpoint
```bash
git tag -a v0.X.0-<name> -m "Description"
git push origin v0.X.0-<name>
```

CHIP'D - Development Context Document for Cursor AI

Last Updated: November 2024
Developer: Solo dev (Full-time job + Family/4 kids)
Timeline: Flexible MVP (Target: April-June 2025)
Environment: Windows (Dev) + Mac (Builds) + Android Galaxy S23 (Primary Test)

APP CONFIGURATION

Bundle ID: io.chipgolf.app
Domain: chipgolf.io
Deep Link Scheme: io.chipgolf.app://login-callback

Authentication (Supabase):
- Email/Password: ENABLED
- Magic Link: ENABLED  
- Anonymous: DISABLED
- Social Logins: DISABLED (removed for MVP simplicity)

PROJECT OVERVIEW

Product Name: CHIP'D
Domain: chipgolf.io (owned)
Tagline: "Verify The Lie"
Positioning: The minimalist, verified caddie. Fast GPS. Hardware-verified scores.

The Problem We Solve

Trust: Golfers cheat on handicaps (sandbaggers).

Bloat: Existing apps (18Birdies, etc.) are slow, ad-heavy, and battery-draining.

Friction: Verification layers that require app-switching fail.

Our Solution

The "Lite" Caddie: Instant Google Maps GPS. Zero ads. High contrast visibility.

Hardware Verification: Physical NFC tags (NTAG 424 DNA) verify player presence.

The Bookend Protocol: Tap Start + Tap Finish = Cryptographic Proof.

Trustless: Locked rounds enable real betting/handicaps.

CODING STANDARDS (NON-NEGOTIABLE)

1. DRY (Don't Repeat Yourself)

Rule: If logic or UI appears twice, refactor it into a generic Widget or Service method immediately.

Architecture: Use a Shared folder for common UI components (buttons, cards) and specific Features folders for unique logic.

Theme: Never hardcode colors/fonts. Always use Theme.of(context).

2. Security First

RLS (Row Level Security): Every Supabase table MUST have RLS policies enabled. No public write access ever.

Input Validation: Never trust client data. Validate all inputs (scores, dates, locations) in Edge Functions before writing to the DB.

Secrets: API Keys (Google Maps) go in local.properties or standard Android/iOS secure files, never committed to Git.

3. Testing Strategy (The "Solo Dev" Safety Net)

Unit Tests: REQUIRED for all business logic (Score calculation, Distance math, JSON parsing).

Widget Tests: REQUIRED for the Core Game Loop (Scorecard input, Map loading).

Edge Function Tests: REQUIRED for verification logic.

DEVELOPMENT CONSTRAINTS (CRITICAL CONTEXT)

1. "Lab Mode" Requirement (Michigan Winter)

Constraint: Developer is in Michigan (winter). Cannot access physical golf courses.

Requirement: The app MUST have a "Debug/Lab Mode" toggle.

Implementation Status:
- LabModeService: lib/services/lab_mode_service.dart (persists state via SharedPreferences)
- UI Toggle: Settings Page > Developer Options > "Enable Lab Mode (Michigan Winter)" switch
- Uses labModeServiceProvider to connect UI to service
- LatLng Model: lib/core/data/models/lat_lng.dart (simple coordinate class)
- deskLocation constant: LatLng(42.808504031807246, -85.98755596334448) - Developer's Michigan desk
- getCurrentLocation() method: Returns deskLocation when Lab Mode enabled, null otherwise (GPS hook point)

Mock GPS: When enabled, the app forces the location to a specific coordinate (e.g., the 1st tee of a test course).

Map Override: The Google Map must center on the Mock Location, not the real location.

2. Time Constraints (Atomic Development)

Constraint: Developer works full-time. Dev sessions are short (30-60 mins).

Requirement: Code must be modular. Avoid monolithic features.

3. AppearanceKit Boilerplate

Constraint: Using AppearanceKit as the base.

Requirement: Leverage existing Auth/UI providers.

TECH STACK

Frontend (Flutter)

Boilerplate: AppearanceKit.

Maps: Maps_flutter (Satellite View is PRIMARY UI).

NFC: nfc_manager.

Backend: supabase_flutter.

State: Riverpod.

Testing: flutter_test, mockito.

Removed for MVP (can add post-MVP if needed):
- Firebase (firebase_core, firebase_messaging, firebase_remote_config, firebase_app_installations)
- Push notifications use local notifications only (flutter_local_notifications)
- Remote config uses stub implementation
- See "FIREBASE REMOVAL" section below for restoration instructions

Backend (Supabase)

Database: PostgreSQL.

Edge Functions: Deno/TypeScript.

DATABASE SCHEMA (Supabase)

See `database_schema.sql` for full schema. Migration: `migrations/001_peer_attestation.sql`

VERIFICATION MODEL: Peer Attestation (supports 2-4 players)
1. GPS proves all players are at the course
2. NFC tap to join round (Captain taps each player's chip)
3. NFC tap to close round (each player taps Captain's chip)
4. Mutual attestation: each player confirms everyone else's scores
5. Verified handicap: calculated from attested rounds only

UNVERIFIED PLAYERS (No Chip):
- Can join via invite link or QR code
- Can enter scores and attest others
- Marked as "unverified" in round
- Rounds count as "partial" verification
- Handicap may not update from unverified rounds
- Creates incentive to get a chip

ROUND WORKFLOW:
```
START:
- Captain creates round, selects course
- Captain taps each player's chip â†’ they join
- GPS verifies all at course location

DURING:
- Each player enters scores on their phone
- Dynamic game prompts based on context:
  â€¢ Par 3 detected â†’ "Closest to Pin?"
  â€¢ Birdie scored â†’ "Start skins game?"
  â€¢ Hole 9 complete â†’ "Nassau bet?"
- Side games created on-the-fly, not pre-configured

END:
- Each player taps Captain's chip (presence verification)
- Attestation screen: confirm everyone's scores
- Side game results confirmed
- Chips settle automatically
- Handicaps update from verified scores
```

Core Tables (MVP):
- users: id, email, display_name, handicap, chip_balance
- courses: id, name, city, state, holes (jsonb)
- nfc_tags: id, uid (unique), owner_id (required), nickname, is_active
- rounds: id, created_by, course_id, player_count, status, verification_level, GPS coords
- round_players: round_id, user_id, tag_uid, join_method, verification_status, scores[], has_attested

Join Methods: 'nfc', 'invite_link', 'qr_code', 'nearby'
Verification Status: 'verified', 'partial', 'unverified'
Round Verification Level: 'full', 'partial', 'none'

Side Games Tables:
- round_games: Dynamic games created during round (CTP, skins, nassau, etc.)
- round_game_players: Who opted into each game, strokes given
- round_game_results: Outcomes per hole/game, confirmed_by array
- chip_transactions: Immutable ledger of all chip movements
- handicap_history: Track handicap changes from verified rounds

Game Types: ctp, skins, nassau, stroke_play, match_play, bingo_bango_bongo, wolf, greenies, sandies, custom

Round Status: 'pending', 'in_progress', 'completed', 'verified', 'disputed'

Triggers:
- on_auth_user_created: Auto-creates users row on signup
- update_*_updated_at: Auto-updates updated_at timestamps

SUBSCRIPTION TIERS:
The chip IS the subscription - physical product = premium access

| Tier | Chip | Verification | Features |
|------|------|--------------|----------|
| Free | None | Unverified | 3 rounds/month, no betting, no handicap |
| Verified | Standard | Full | Unlimited rounds, betting, handicap |
| The 900 | Gold | Full | Lifetime, founder badge, early access |

Tables:
- subscriptions: user_id, tier, status, the_900_number, expires_at
- tier_features: View of feature access per tier

MVP FEATURE SCOPE

Phase 1: The "Desk" Prototype (Weeks 1-4)

Goal: Prove the NFC handshake works.

Lab Mode: Mock GPS location so dev can "play" at his desk.

Phase 2: The "Lite" Caddie (Weeks 5-8)

Visuals: Google Maps Satellite view is the background of the active round screen.

Distance: Real-time distance from User to Green Center.

Speed: Must load faster than 18Birdies.

Phase 3: Token Logic & Polish (Weeks 9+)

Rewards and UI cleanup.

REMINDERS FOR CURSOR AI

Lab Mode First: Always ensure Google Maps works with the Mock Location provider.

API Keys: Remind the user to add Google Maps API keys to android/app/src/main/AndroidManifest.xml and ios/Runner/AppDelegate.swift.

Map Performance: Use BitmapDescriptor for markers to keep performance high.

No Bloat: Do NOT suggest adding social feeds, wind tracking, or complex stats. Keep the UI focused on "Yardage + Score".

Test First: When writing logic, suggest the Unit Test before or with the implementation.

FIREBASE REMOVAL (MVP Decision)

Status: Firebase dependencies removed for MVP to simplify development.

Rationale: Push notifications and remote config are NOT in MVP scope. The core MVP is GPS + NFC + Scorecard.

What was removed:
- firebase_core, firebase_messaging, firebase_remote_config, firebase_app_installations from pubspec.yaml
- Firebase.initializeApp() from main.dart
- Google Services plugin from android/app/build.gradle.kts and android/settings.gradle.kts
- RemoteConfigApi now uses StubRemoteConfigApi (no-op)
- NotificationsApi now uses LocalNotificationsApi (local only, no push)
- DeviceApi now uses StubDeviceApi (no Firebase token management)

What still works:
- Local notifications via flutter_local_notifications
- Supabase-stored notifications (can be fetched and displayed)
- All other app functionality

To restore Firebase (post-MVP):
1. Add to pubspec.yaml: firebase_core, firebase_messaging, firebase_remote_config, firebase_app_installations
2. Run: dart pub global activate flutterfire_cli && flutterfire configure
3. Add google-services plugin back to Gradle files
4. Restore Firebase.initializeApp() in main.dart
5. Replace stub implementations with Firebase implementations in:
   - lib/core/data/api/remote_config_api.dart
   - lib/modules/notifications/api/notifications_api.dart
   - lib/modules/notifications/api/device_api.dart