---
description: Month 1 Sprint Plan - Desk Prototype
globs:
alwaysApply: false
---

# CHIP'D Month 1: Desk Prototype Sprint Guide

## Current Status

### Completed âœ…
- [x] Theme system (CHIP'D colors, typography)
- [x] Lab Mode service foundation
- [x] Git workflow established
- [x] Auth flow (email/password)
- [x] Supabase connection
- [x] **Database Schema v1.1.0 deployed** (rounds, round_players, games, subscriptions)

### In Progress ðŸ”„
- [ ] NFC service implementation
- [ ] Round flow UI
- [ ] GPS integration with Lab Mode

---

## Database Schema (DEPLOYED)

The following tables are now live in Supabase:

```
âœ… users (with tier, chip_balance)
âœ… courses (with holes jsonb)
âœ… nfc_tags (player-owned, nickname)
âœ… rounds (created_by, verification_level, GPS coords)
âœ… round_players (join_method, verification_status, scores)
âœ… round_games (dynamic side games)
âœ… round_game_players
âœ… round_game_results
âœ… chip_transactions
âœ… handicap_history
âœ… subscriptions (free, verified, the_900)
```

**No more backend schema work needed for MVP!**

---

## Multi-Agent Strategy (4 Agents)

| Agent | Track | Focus Area |
|-------|-------|------------|
| **Agent 1** | ðŸ—„ï¸ Backend | Edge Functions, API calls |
| **Agent 2** | ðŸ“± UI | Screens, widgets, navigation |
| **Agent 3** | âš™ï¸ Services | NFC, GPS, state management |
| **Agent 4** | ðŸ§ª Testing | Unit tests, widget tests |

---

## WEEK 1: Lab Mode & NFC Foundation

### Day 1-2: GPS + Lab Mode Integration

**Agent 2 (UI):**
```
Create TestGpsScreen in lib/modules/debug/ui/test_gps_screen.dart:
- Large button: "Get Current Location"
- Display: lat/lng coordinates
- Lab Mode indicator badge
- Add navigation from Settings > Developer Options
```

**Agent 3 (Services):**
```
Update LabModeService:
1. Add geolocator dependency
2. getCurrentLocation() method:
   - Lab Mode ON â†’ return deskLocation
   - Lab Mode OFF â†’ use Geolocator.getCurrentPosition()
3. Add location permission handling
4. Add LocationService wrapper for the app to use
```

**Agent 4 (Testing):**
```
Update test/services/lab_mode_service_test.dart:
- Test: Lab Mode returns deskLocation
- Test: Lab Mode OFF returns real/null coords
- Test: Toggle persists across restarts
```

**ðŸ›‘ Sync Point:** GPS works in Lab Mode. App shows coordinates.

---

### Day 3-4: NFC Service

**Agent 2 (UI):**
```
Create TagRegistrationScreen in lib/modules/nfc/ui/tag_registration_screen.dart:
- Center layout with large NFC icon
- "Scan Your Chip" button (primary green CTA)
- Status text for feedback
- Loading overlay during scan
- Success/Error states
- Shows tag nickname input after successful scan
```

**Agent 3 (Services):**
```
Create NfcService in lib/modules/nfc/services/nfc_service.dart:
- Use nfc_manager package
- Method: startSession({onDiscovered, onError})
- Method: stopSession()
- Extract UID as uppercase hex string
- Handle Android/iOS differences
- Create NfcServiceFake for testing
```

**Agent 4 (Testing):**
```
Create tests:
- test/modules/nfc/nfc_service_test.dart
- Test: UID extraction formats correctly (14 hex chars)
- Test: Error handling for session failures
- Test: Session cleanup on dispose
```

**ðŸ›‘ Sync Point:** NFC service reads tags. UI shows scanned UID.

---

### Day 5: Tag Registration Flow

**Agent 1 (Backend):**
```
Create Edge Function: supabase/functions/register-tag/index.ts
- Input: { tagUid: string, nickname?: string }
- Auth: Require authenticated user
- Check user tier (must be 'verified' or 'the_900')
- Check if tag already registered â†’ Error 409
- Insert into nfc_tags with owner_id
- Return success with tag details
```

**Agent 2 (UI):**
```
Connect TagRegistrationScreen to NfcService and API:
- On scan â†’ Show loading, call register-tag API
- On success â†’ Show nickname input, then green checkmark
- On error â†’ Show specific message:
  - "Tag already registered"
  - "Upgrade to register a chip" (free tier)
- Navigate to "My Chips" screen
```

**Agent 3 (Services):**
```
Create NfcTagRepository in lib/modules/nfc/repositories/nfc_tag_repository.dart:
- Method: registerTag(uid, nickname) â†’ Future<NfcTag>
- Method: getMyTags() â†’ Future<List<NfcTag>>
- Method: lookupTagOwner(uid) â†’ Future<User?>
- Create NfcTag domain model
```

**ðŸ›‘ Sync Point:** Can register a physical NFC tag to account.

---

## WEEK 2: Round System (Captain Model)

### Day 1-2: Start Round Flow

**Agent 2 (UI):**
```
Create StartRoundScreen in lib/modules/rounds/ui/start_round_screen.dart:
- Header: "Start New Round"
- Lab Mode badge (if enabled)
- Course selector (optional dropdown)
- Player count selector: [2] [3] [4]
- Large "Tap Players In" button
- Bottom sheet for adding players:
  - "Scan Chip" option (verified)
  - "Share Invite Link" option (unverified)
- Player list showing who's joined (with verification badges)
- "Start Round" button (enabled when 2+ players)
```

**Agent 3 (Services):**
```
Create RoundService in lib/modules/rounds/services/round_service.dart:
- Round domain model (from rounds + round_players)
- RoundPlayer domain model

Methods:
- createRound(courseId?) â†’ Future<Round>
- addPlayerByNfc(roundId, tagUid) â†’ Future<RoundPlayer>
- addPlayerByInvite(roundId, userId) â†’ Future<RoundPlayer>
- startRound(roundId) â†’ Future<Round>
- getActiveRound() â†’ Future<Round?>
- getMyRounds() â†’ Future<List<Round>>
```

**Agent 4 (Testing):**
```
test/modules/rounds/round_service_test.dart:
- Test: Create round sets created_by correctly
- Test: Add player by NFC sets verification_status = 'verified'
- Test: Add player by invite sets verification_status = 'unverified'
- Test: Cannot add same player twice
- Test: Cannot add more than 4 players
```

**ðŸ›‘ Sync Point:** Can create round and add players via NFC or invite.

---

### Day 3-4: Active Round Screen

**Agent 2 (UI):**
```
Create ActiveRoundScreen in lib/modules/rounds/ui/active_round_screen.dart:
- Timer display (counting from start_time)
- Player cards grid (2x2 for foursome):
  - Name, avatar
  - Verification badge (âœ“ verified, â—‹ unverified)
  - Score entry for current hole
- Current hole indicator
- Course name (if selected)
- "Next Hole" button
- "Finish Round" button (bottom)

Create PlayerScoreCard widget:
- Tap to enter score
- Par as default, +/- buttons
- Shows running total
```

**Agent 3 (Services):**
```
Create RoundStateNotifier in lib/modules/rounds/providers/round_state_notifier.dart:
- Riverpod AsyncNotifier
- States: idle, creating, active, closing, completed
- Real-time sync with Supabase (or polling)
- Method: updateScore(playerId, hole, score)
- Method: nextHole()
- Method: closeRound()

Create round timer provider:
- Emits elapsed time every second
- Format as HH:MM:SS
```

**Agent 4 (Testing):**
```
test/modules/rounds/active_round_test.dart:
- Test: Timer updates correctly
- Test: Score updates sync to round_players.scores
- Test: Next hole increments correctly
- Test: Can't exceed 18 holes
```

**ðŸ›‘ Sync Point:** Can play through round, entering scores.

---

### Day 5: Close Round & Attestation

**Agent 2 (UI):**
```
Create CloseRoundFlow:
1. Captain taps "Close Round"
2. Bottom sheet: "Have each player tap your chip"
3. As each player taps:
   - Show their name + "Verified âœ“"
   - Update round_players.close_verified_at
4. After all verified (or timeout):
   - Show attestation screen

Create AttestationScreen:
- Show all player scores
- Each player on their phone sees:
  - All scores listed
  - [Confirm All] [Dispute] buttons
- When all confirm â†’ Round status = 'verified'
```

**Agent 3 (Services):**
```
Update RoundService:
- Method: verifyPlayerClose(roundId, tagUid) â†’ marks player as close-verified
- Method: attestRound(roundId) â†’ sets has_attested = true for current user
- Method: checkAllAttested(roundId) â†’ updates round status if all attested

Logic:
- Round is 'verified' when all round_players have has_attested = true
- verification_level calculated from player verification statuses
```

**Agent 4 (Testing):**
```
test/modules/rounds/close_round_test.dart:
- Test: NFC tap updates close_verified_at
- Test: Attestation sets has_attested
- Test: All attested â†’ round status = 'verified'
- Test: Unverified players can still attest
```

**ðŸ›‘ Sync Point:** Full round flow works: Create â†’ Play â†’ Close â†’ Attest â†’ Verified

---

## WEEK 3: Polish & Integration

### Day 1-2: Round History & Home Screen

**Agent 2 (UI):**
```
Create RoundHistoryScreen:
- List of past rounds
- Each card shows:
  - Date, course
  - Players (with verification badges)
  - Scores
  - Round verification_level badge
- Tap to see details

Update HomeScreen:
- "Active Round" banner if one exists
- "Start Round" CTA
- Recent rounds list
- Quick stats (rounds played, verified count)
```

**Agent 3 (Services):**
```
Create RoundHistoryRepository:
- Method: getMyRounds(limit, offset) â†’ paginated
- Method: getRoundDetails(roundId) â†’ full round with players
- Cache recent rounds locally
```

---

### Day 3-4: Invite Flow (Unverified Players)

**Agent 2 (UI):**
```
Create InvitePlayerFlow:
- Generate invite link/code for round
- Share sheet (SMS, copy link)
- QR code display option

Create JoinRoundScreen:
- Opens from deep link
- Shows round info
- "Join Round" button
- Adds user as unverified player
```

**Agent 3 (Services):**
```
Create InviteService:
- Method: generateInviteLink(roundId) â†’ URL
- Method: joinRoundByInvite(inviteCode) â†’ adds player
- Handle deep link routing
```

---

### Day 5: Desk Golf Championship Test

**Full Integration Test:**
```
1. Ensure Lab Mode ON
2. Login with test account (Captain)
3. Create new round
4. Scan Tag A â†’ Player added (verified)
5. [Optional] Share invite link â†’ Player joins (unverified)
6. Start round
7. Enter scores for 3-4 holes
8. Tap "Close Round"
9. Player A taps Captain's chip
10. Both players attest scores
11. Verify: round status = 'verified'
12. Check round history shows correct badges
```

---

## WEEK 4: Buffer & Hardening

### Focus Areas:
- Bug fixes from Week 3 testing
- Edge case handling (network failures, interrupted rounds)
- Performance optimization
- Code cleanup and documentation
- Prepare for Phase 2 (Maps integration)

### Nice-to-Have (if time):
- Score entry animations
- Haptic feedback on NFC scan
- Sound effects
- Round sharing (social)

---

## Git Workflow

```bash
# Before starting any work
git pull origin master

# Create feature branch
git checkout -b feature/week1-nfc-service

# After completion
git add -A
git commit -m "feat(nfc): implement NFC service with UID extraction"
git push origin feature/week1-nfc-service

# Merge to master when tested
```

## Checkpoint Tags

```bash
# After Week 1
git tag -a v0.2.0-phase1-nfc -m "NFC Service + Tag Registration"

# After Week 2
git tag -a v0.2.1-phase1-rounds -m "Round System Complete"

# After Week 3
git tag -a v0.2.2-phase1-invite -m "Invite Flow + History"

# After Week 4
git tag -a v0.3.0-desk-prototype -m "Desk Prototype Complete"
```

---

## Key Architecture Notes

### Round Flow (Captain Model)
```
Captain creates round
  â†’ Captain taps each player's chip (verified)
  â†’ OR shares invite link (unverified)
  â†’ Round starts

During round:
  â†’ Each player enters scores on their phone
  â†’ Scores sync via round_players.scores

Close round:
  â†’ Captain initiates close
  â†’ Each player taps Captain's chip
  â†’ All players attest scores
  â†’ Round verified
```

### Verification Levels
```
full: All players joined AND closed via NFC
partial: Some players verified, some not
none: All players joined via invite
```

### Subscription Tiers
```
free: No chip, join via invite only, limited features
verified: Has chip, full features
the_900: Gold chip, lifetime, founder perks
```
