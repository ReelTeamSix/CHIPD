---
description: Month 1 Sprint Plan - Desk Prototype
globs:
alwaysApply: false
---

# CHIP'D Month 1: Desk Prototype Sprint Guide

## Multi-Agent Strategy (4 Agents)

### Agent Roles
| Agent | Track | Focus Area |
|-------|-------|------------|
| **Agent 1** | ðŸ—„ï¸ Backend | Supabase schema, RLS policies, Edge Functions |
| **Agent 2** | ðŸ“± UI | Screens, widgets, navigation |
| **Agent 3** | âš™ï¸ Services | Business logic, NFC, GPS, state management |
| **Agent 4** | ðŸ§ª Testing | Unit tests, widget tests, integration tests |

### Parallelization Rules
- âœ… Agents can work in parallel on independent tracks
- âš ï¸ Wait for dependencies before starting dependent work
- ðŸ”„ Sync at end of each day/sprint block

---

## Pre-Sprint Checklist (Already Complete)
- [x] Theme system (CHIP'D colors, typography)
- [x] Lab Mode service foundation
- [x] Git workflow established
- [x] Branch protection configured

---

## WEEK 1: Lab Mode & GPS

### Day 1-2: Parallel Sprint Block

**Agent 1 (Backend):**
```
Create Supabase migration for `courses` table:
- id (uuid, primary key)
- name (text)
- holes (jsonb) - Array of {hole_number, par, green_lat, green_lng, tee_lat, tee_lng}
- created_at (timestamptz)

RLS: SELECT for authenticated users. INSERT/UPDATE for admin only.

Also create `test_courses` seed data with 1-2 mock courses for Lab Mode testing.
```

**Agent 2 (UI):**
```
Review existing Settings screen. Ensure Lab Mode toggle is connected to LabModeService.
Create a new screen: `TestGpsScreen` in lib/modules/debug/ui/test_gps_screen.dart
- Large button: "Get Current Location"
- Display area showing lat/lng coordinates
- Add navigation from Settings > Developer Options
```

**Agent 3 (Services):**
```
Update LabModeService to integrate with Geolocator package:
1. Add geolocator dependency if not present
2. Update getCurrentLocation() method:
   - If Lab Mode ON: return deskLocation immediately
   - If Lab Mode OFF: use Geolocator.getCurrentPosition()
3. Add permission handling for location services
```

**Agent 4 (Testing):**
```
Create/update tests for LabModeService:
- test/services/lab_mode_service_test.dart
- Test cases:
  1. Toggle persists across restarts (mock SharedPreferences)
  2. getCurrentLocation returns deskLocation when enabled
  3. getCurrentLocation returns null/real coords when disabled
```

**ðŸ›‘ Sync Point:** All agents commit. Run `flutter test`. Verify app launches.

---

### Day 3-4: NFC Foundation

**Agent 1 (Backend):**
```
Create Supabase migration for `nfc_tags` table:
- uid (text, primary key) - The NFC tag's unique ID
- owner_id (uuid, references auth.users)
- registered_at (timestamptz)
- status (text) - 'active', 'revoked'

RLS Policies:
- SELECT: Users can only see their own tags
- INSERT: Users can insert new tags (uid not already registered)
- UPDATE: Users can only update their own tags
- DELETE: Disabled
```

**Agent 2 (UI):**
```
Create TagRegistrationScreen in lib/modules/nfc/ui/tag_registration_screen.dart:
- Center layout with large NFC icon
- "Scan New Tag" button (primary green CTA)
- Status text area for feedback
- Loading overlay during scan/registration
- Success/Error states with appropriate messaging
```

**Agent 3 (Services):**
```
Create NfcService in lib/modules/nfc/services/nfc_service.dart:
- Use nfc_manager package
- Method: startSession({required Function(String uid) onDiscovered, required Function(String error) onError})
- Method: stopSession()
- Extract UID as uppercase hex string
- Handle platform-specific behavior (Android vs iOS)
- Wrap in try-catch for security
```

**Agent 4 (Testing):**
```
Create test mocks and tests for NFC:
- test/mocks/mock_nfc_service.dart - Fake implementation for UI testing
- test/modules/nfc/nfc_service_test.dart
- Test cases:
  1. UID extraction formats correctly
  2. Error handling for session failures
  3. Session cleanup on dispose
```

**ðŸ›‘ Sync Point:** Deploy SQL to Supabase. Verify table exists. Run tests.

---

### Day 5: Integration Sprint

**Agent 1 (Backend):**
```
Create Edge Function: supabase/functions/register-tag/index.ts
- Input: { tagUid: string }
- Auth: Require authenticated user
- Logic:
  1. Check if tag already registered â†’ Error 409
  2. Insert new row with owner_id = user.id
  3. Return success with tag details
- Standardized error responses: { error: string, code: string }
```

**Agent 2 (UI):**
```
Connect TagRegistrationScreen to NfcService and API:
- On button tap: Start NFC session
- On tag discovered: Show loading, call register-tag Edge Function
- On success: Show green checkmark animation, navigate back
- On error: Show error message, allow retry
- Handle "Tag already registered" specifically
```

**Agent 3 (Services):**
```
Create NfcTagRepository in lib/modules/nfc/repositories/nfc_tag_repository.dart:
- Method: registerTag(String uid) â†’ Future<NfcTag>
- Method: getMyTags() â†’ Future<List<NfcTag>>
- Create NfcTag domain model
- Handle API errors with proper error types
```

**Agent 4 (Testing):**
```
Create integration tests:
- test/modules/nfc/tag_registration_test.dart
- Test the full flow with mocked services
- Verify UI states: idle â†’ scanning â†’ loading â†’ success/error
```

**ðŸ›‘ Sync Point:** Deploy Edge Function. Test on physical Android device with real NFC tag.

---

## WEEK 2: Rounds System

### Day 1-2: Database & Models

**Agent 1 (Backend):**
```
Create Supabase migration for `rounds` table:
- id (uuid, primary key)
- player_a_id (uuid, references auth.users) - Round initiator
- player_b_id (uuid, references auth.users) - Partner
- player_a_tag_uid (text) - Tag used by player A
- player_b_tag_uid (text) - Tag used by player B
- course_id (uuid, references courses, nullable)
- start_time (timestamptz)
- end_time (timestamptz, nullable)
- status (text) - 'pending', 'active', 'completed', 'verified', 'disputed'
- created_at (timestamptz)

RLS: Users see rounds where they are player_a OR player_b.
```

**Agent 2 (UI):**
```
Create StartRoundScreen in lib/modules/rounds/ui/start_round_screen.dart:
- Header: "Start New Round"
- Lab Mode indicator (if enabled, show mock location notice)
- Course selector (dropdown, optional for MVP)
- Large "Start Round" button
- Partner scan modal (triggered on button tap)
```

**Agent 3 (Services):**
```
Create RoundService in lib/modules/rounds/services/round_service.dart:
- Create Round domain model with freezed
- Create RoundRepository
- Method: startRound(partnerTagUid: String) â†’ Future<Round>
- Method: getActiveRound() â†’ Future<Round?>
- Method: finishRound(roundId: String, verificationTagUid: String) â†’ Future<Round>
```

**Agent 4 (Testing):**
```
Create round logic tests:
- test/modules/rounds/round_service_test.dart
- Test: Cannot start round with own tag
- Test: Cannot start round if already in active round
- Test: Round status transitions correctly
```

**ðŸ›‘ Sync Point:** SQL deployed. Models compile. Tests pass.

---

### Day 3-4: Start Round Flow

**Agent 1 (Backend):**
```
Create Edge Function: supabase/functions/start-round/index.ts
- Input: { partnerTagUid: string, courseId?: string }
- Validation:
  1. Partner tag must exist and be registered
  2. Partner tag cannot be caller's own tag
  3. Neither player can have an active round already
- Create round with status='active', start_time=now()
- Return round details including partner info
```

**Agent 2 (UI):**
```
Build the partner scan modal flow:
1. On "Start Round" tap â†’ Open bottom sheet modal
2. Modal shows "Scan Partner's Tag" with NFC icon
3. Start NFC session automatically
4. On scan â†’ Show partner's name/avatar (lookup from tag)
5. Confirm button â†’ Call start-round API
6. On success â†’ Navigate to ActiveRoundScreen
```

**Agent 3 (Services):**
```
Create RoundStateNotifier in lib/modules/rounds/providers/round_state_notifier.dart:
- Riverpod AsyncNotifier for round state
- States: idle, scanning, starting, active, finishing, completed
- Method: scanPartner() - Triggers NFC scan
- Method: confirmStart(partnerTagUid) - Calls API
- Method: finishRound() - Triggers verification flow
```

**Agent 4 (Testing):**
```
Test round start scenarios:
- test/modules/rounds/start_round_test.dart
- Test: Valid partner tag starts round
- Test: Own tag shows error
- Test: Unregistered tag shows error
- Test: Already in round shows error
```

**ðŸ›‘ Sync Point:** Full start round flow works on device.

---

### Day 5: Active Round Dashboard

**Agent 2 (UI):**
```
Create ActiveRoundScreen in lib/modules/rounds/ui/active_round_screen.dart:
- Timer display (counting up from start_time)
- Player A card (left) - Name, avatar
- Player B card (right) - Name, avatar  
- Course name (if selected)
- "Finish & Verify" button (bottom, prominent)

Extract reusable PlayerCard widget.
```

**Agent 3 (Services):**
```
Create round timer logic:
- Provider that emits elapsed time every second
- Calculate from round.start_time to now()
- Format as HH:MM:SS
```

**Agent 4 (Testing):**
```
Widget tests for ActiveRoundScreen:
- test/modules/rounds/active_round_screen_test.dart
- Test: Timer displays and updates
- Test: Player cards show correct info
- Test: Finish button is tappable
```

---

## WEEK 3: Verification & Finish

### Day 1-2: Finish Round Logic

**Agent 1 (Backend):**
```
Create Edge Function: supabase/functions/verify-round/index.ts
- Input: { roundId: string, verificationTagUid: string }
- Validation:
  1. Round exists and caller is a player
  2. Round status is 'active'
  3. Verification tag matches partner's tag
  4. Minimum round duration check (optional, e.g., 30 seconds)
- Update: status='verified', end_time=now()
- Return updated round
```

**Agent 2 (UI):**
```
Build finish round flow in ActiveRoundScreen:
1. On "Finish & Verify" tap â†’ Open verification modal
2. Modal: "Scan Partner's Tag to Verify"
3. Start NFC session
4. On scan â†’ Call verify-round API
5. On success â†’ Show success animation, update UI
6. On error (wrong tag) â†’ Show error, allow retry
```

**Agent 3 (Services):**
```
Update RoundStateNotifier with finish flow:
- Method: startVerification() - Opens modal, starts NFC
- Method: submitVerification(tagUid) - Calls verify API
- Handle verification errors gracefully
- Update local state on success
```

**Agent 4 (Testing):**
```
Test verification scenarios:
- test/modules/rounds/verify_round_test.dart
- Test: Correct partner tag verifies
- Test: Wrong tag shows error
- Test: Own tag shows error
- Test: Unregistered tag shows error
```

**ðŸ›‘ Sync Point:** Full round lifecycle works: Start â†’ Active â†’ Verify

---

### Day 3-4: Polish & Edge Cases

**Agent 2 (UI):**
```
Add success/completion states:
- Verification success animation (green checkmark, confetti optional)
- Round summary screen showing:
  - Duration
  - Players
  - "Verified" badge
- Round history list on home screen
```

**Agent 3 (Services):**
```
Handle edge cases:
- App backgrounded during round (persist state)
- Network failure during verification (retry logic)
- Session timeout handling
- Clean up NFC sessions properly
```

**Agent 4 (Testing):**
```
End-to-end flow test:
- test/integration/full_round_flow_test.dart
- Mock all services
- Test complete flow: Login â†’ Start â†’ Active â†’ Verify â†’ History
```

---

### Day 5: Milestone - Desk Prototype Complete

**All Agents - Full Integration Test:**
```
Perform "Desk Golf Championship" test:
1. Ensure Lab Mode ON
2. Login with test account
3. Navigate to Start Round
4. Scan "Partner" tag (second registered tag)
5. Verify round starts, timer counting
6. Wait 60+ seconds
7. Tap "Finish & Verify"
8. Scan "Partner" tag again
9. Verify green checkmark appears
10. Check Supabase: rounds table has verified row

Document any issues found.
```

---

## WEEK 4: Buffer & Hardening

Reserve for:
- Bug fixes from Week 3 testing
- Performance optimization
- Code cleanup and documentation
- Additional edge case handling
- Preparing for Phase 2 (Maps integration)

---

## Git Workflow Per Sprint Block

```bash
# Before starting
git pull origin develop

# Create feature branch
git checkout -b feature/week1-day1-labmode

# After completion
git add -A
git commit -m "feat(labmode): <description>"
git push origin feature/week1-day1-labmode

# Create PR to develop, merge, then:
git checkout develop
git pull origin develop
```

## Checkpoint Tags
```bash
# After Week 1
git tag -a v0.2.0-phase1-labmode -m "Lab Mode & GPS complete"

# After Week 2  
git tag -a v0.2.1-phase1-nfc -m "NFC Registration complete"

# After Week 3
git tag -a v0.2.2-phase1-rounds -m "Round system complete"

# After Week 4
git tag -a v0.3.0-desk-prototype -m "Desk Prototype MVP complete"
```
